<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceBot Admin - Complete Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .button.secondary {
            background: #6c757d;
        }

        .button.danger {
            background: #dc3545;
        }

        .button.success {
            background: #28a745;
        }

        .api-group {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .api-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .api-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .validate-btn {
            padding: 6px 12px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status.valid {
            background: #d4edda;
            color: #155724;
        }

        .status.invalid {
            background: #f8d7da;
            color: #721c24;
        }

        .status.pending {
            background: #fff3cd;
            color: #856404;
        }

        /* Document Management Styles */
        .document-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }

        .document-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .document-info {
            flex: 1;
        }

        .document-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .document-meta {
            font-size: 12px;
            color: #666;
        }

        .document-actions {
            display: flex;
            gap: 8px;
        }

        .upload-zone {
            border: 3px dashed #e0e0e0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .search-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .search-results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .result-item {
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .result-score {
            display: inline-block;
            padding: 2px 6px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: #2a2b2e;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #888;
            cursor: pointer;
        }

        .close:hover {
            color: #f1f1f1;
        }

        /* Tool & Workflow Cards */
        .tool-card, .workflow-card {
            background: #1e1f21;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .tool-card:hover, .workflow-card:hover {
            border-color: #0084ff;
        }

        .tool-header, .workflow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .tool-name, .workflow-name {
            font-weight: 600;
            font-size: 16px;
        }

        .tool-type {
            background: #0084ff;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .tool-description, .workflow-description {
            color: #999;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .tool-actions, .workflow-actions {
            display: flex;
            gap: 10px;
        }

        .workflow-step {
            background: #1e1f21;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            position: relative;
        }

        .workflow-step-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .step-number {
            background: #0084ff;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .step-remove {
            position: absolute;
            right: 10px;
            top: 10px;
            color: #ff4444;
            cursor: pointer;
        }

        /* Small button styles */
        .button.small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .button.danger {
            background: #ff4444;
        }

        .button.danger:hover {
            background: #ff6666;
        }

        .button.success {
            background: #44ff44;
            color: #1e1f21;
        }

        .button.success:hover {
            background: #66ff66;
        }

        /* Switch styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #0084ff;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎙️ VoiceBot Admin Panel</h1>
            <p>Configure your AI voice assistant, manage documents, and API integrations</p>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('bot')">Bot Settings</button>
                <button class="tab" onclick="switchTab('documents')">Document Management</button>
                <button class="tab" onclick="switchTab('apis')">API Configuration</button>
                <button class="tab" onclick="switchTab('tools')">Tools & Workflows</button>
                <button class="tab" onclick="switchTab('test')">Test Assistant</button>
            </div>
        </div>

        <div id="alert" class="alert"></div>

        <!-- Bot Settings Tab -->
        <div id="bot-tab" class="tab-content active">
            <div class="main-grid">
                <div class="card">
                    <h2>Voice Configuration</h2>
                    <div class="form-group">
                        <label for="voice">Voice Selection</label>
                        <select id="voice">
                            <option value="alloy">Alloy (Neutral)</option>
                            <option value="shimmer" selected>Shimmer (Expressive)</option>
                            <option value="echo">Echo (Smooth)</option>
                            <option value="ash">Ash</option>
                            <option value="ballad">Ballad</option>
                            <option value="coral">Coral</option>
                            <option value="sage">Sage</option>
                            <option value="verse">Verse</option>
                            <option value="marin">Marin</option>
                            <option value="cedar">Cedar</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="model">Model</label>
                        <select id="model">
                            <option value="gpt-realtime" selected>GPT Realtime</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="temperature">Temperature (0-2)</label>
                        <input type="number" id="temperature" min="0" max="2" step="0.1" value="0.8">
                    </div>
                    
                    <button class="button" onclick="saveSettings()">Save Voice Settings</button>
                </div>

                <div class="card">
                    <h2>Personality & Behavior</h2>
                    <div class="form-group">
                        <label for="instructions">System Instructions</label>
                        <textarea id="instructions">You are an incredibly expressive and enthusiastic voice assistant with a vibrant personality! Speak with natural emotion, varying your tone, pace, and inflection to match the context.</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="greeting">Greeting Message</label>
                        <input type="text" id="greeting" value="Hello! I'm your AI assistant. How can I help you today?">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="useEmoji"> Use Emojis
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="useHumor" checked> Use Humor
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="beExpressive" checked> Be Expressive
                        </label>
                    </div>
                    
                    <button class="button" onclick="saveSettings()">Save Personality</button>
                </div>

                <div class="card">
                    <h2>Session Settings</h2>
                    <div class="form-group">
                        <label for="maxTokens">Max Tokens</label>
                        <input type="number" id="maxTokens" value="4096">
                    </div>
                    
                    <div class="form-group">
                        <label for="sessionTimeout">Session Timeout (seconds)</label>
                        <input type="number" id="sessionTimeout" value="300">
                    </div>
                    
                    <div class="form-group">
                        <label for="contextWindow">Context Window</label>
                        <select id="contextWindow">
                            <option value="short">Short (2k tokens)</option>
                            <option value="medium" selected>Medium (4k tokens)</option>
                            <option value="long">Long (8k tokens)</option>
                        </select>
                    </div>
                    
                    <button class="button" onclick="saveSettings()">Save Session Settings</button>
                </div>

                <div class="card">
                    <h2>Feature Toggles</h2>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="ragEnabled" checked> Enable RAG (Document Search)
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="webSearchEnabled" checked> Enable Web Search
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="flightSearchEnabled" checked> Enable Flight Search
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="weatherEnabled" checked> Enable Weather
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="cameraEnabled" checked> Enable Camera/Image Analysis
                        </label>
                    </div>
                    
                    <!-- Camera Settings (shown when camera is enabled) -->
                    <div id="cameraSettingsGroup" style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="margin-top: 0;">Camera Settings</h4>
                        
                        <div class="form-group">
                            <label>Resolution</label>
                            <select id="cameraResolution" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                <option value="640x480">640x480 (VGA)</option>
                                <option value="1280x720">1280x720 (HD)</option>
                                <option value="1920x1080" selected>1920x1080 (Full HD)</option>
                                <option value="2560x1440">2560x1440 (2K)</option>
                                <option value="3840x2160">3840x2160 (4K)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Image Quality: <span id="cameraQualityValue">92%</span></label>
                            <input type="range" id="cameraQuality" min="0.5" max="1.0" step="0.05" value="0.92" style="width: 100%;">
                        </div>
                        
                        <div class="form-group">
                            <label>Frame Rate</label>
                            <select id="cameraFrameRate" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                <option value="15">15 FPS</option>
                                <option value="24">24 FPS</option>
                                <option value="30" selected>30 FPS</option>
                                <option value="60">60 FPS</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="moderationEnabled" checked> Enable Content Moderation
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="loggingEnabled" checked> Enable Conversation Logging
                        </label>
                    </div>
                    
                    <button class="button" onclick="saveSettings()">Save Features</button>
                </div>
            </div>
        </div>

        <!-- Document Management Tab -->
        <div id="documents-tab" class="tab-content">
            <div class="main-grid">
                <div class="card">
                    <h2>Upload Documents</h2>
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                        <p>📁 Click or drag files here to upload</p>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            Supported: PDF, TXT, MD, CSV, JSON, PNG, JPG
                        </p>
                        <input type="file" id="fileInput" style="display: none;" multiple accept=".pdf,.txt,.md,.csv,.json,.png,.jpg,.jpeg">
                    </div>
                    
                    <div class="loading" id="uploadLoading">
                        <div class="spinner"></div>
                        <p>Processing documents...</p>
                    </div>
                </div>

                <div class="card">
                    <h2>Search Documents</h2>
                    <div class="search-box">
                        <input type="text" class="search-input" id="searchQuery" placeholder="Enter search query...">
                        <button class="search-button" onclick="searchDocuments()">Search</button>
                    </div>
                    
                    <div class="search-results" id="searchResults">
                        <h3>Search Results</h3>
                        <div id="searchResultsList"></div>
                    </div>
                </div>

                <div class="card" style="grid-column: 1 / -1;">
                    <h2>Document Library</h2>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span id="documentCount">0 documents</span>
                        <button class="button danger" onclick="clearAllDocuments()">Clear All</button>
                    </div>
                    
                    <div class="document-list" id="documentList">
                        <p style="text-align: center; color: #666;">No documents uploaded yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Configuration Tab -->
        <div id="apis-tab" class="tab-content">
            <div class="main-grid">
                <div class="card">
                    <h2>OpenAI Configuration</h2>
                    <div class="api-group">
                        <div class="api-header">
                            <span class="api-title">OpenAI API</span>
                            <button class="validate-btn" onclick="validateApi('openai')">Validate</button>
                        </div>
                        <div class="form-group">
                            <label for="openaiKey">API Key</label>
                            <input type="password" id="openaiKey" placeholder="sk-...">
                        </div>
                        <div class="form-group">
                            <label for="openaiOrg">Organization ID (Optional)</label>
                            <input type="text" id="openaiOrg" placeholder="org-...">
                        </div>
                        <div id="openaiStatus" class="status pending">Not validated</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Google Search Configuration</h2>
                    <div class="api-group">
                        <div class="api-header">
                            <span class="api-title">Google Custom Search</span>
                            <button class="validate-btn" onclick="validateApi('google')">Validate</button>
                        </div>
                        <div class="form-group">
                            <label for="googleKey">API Key</label>
                            <input type="password" id="googleKey" placeholder="AIza...">
                        </div>
                        <div class="form-group">
                            <label for="googleSearchEngineId">Search Engine ID</label>
                            <input type="text" id="googleSearchEngineId" placeholder="cx:...">
                        </div>
                        <div id="googleStatus" class="status pending">Not validated</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Amadeus Flight Search</h2>
                    <div class="api-group">
                        <div class="api-header">
                            <span class="api-title">Amadeus API</span>
                            <button class="validate-btn" onclick="validateApi('amadeus')">Validate</button>
                        </div>
                        <div class="form-group">
                            <label for="amadeusClientId">Client ID</label>
                            <input type="text" id="amadeusClientId" placeholder="Client ID">
                        </div>
                        <div class="form-group">
                            <label for="amadeusClientSecret">Client Secret</label>
                            <input type="password" id="amadeusClientSecret" placeholder="Client Secret">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="amadeusSandbox" checked> Use Sandbox Environment
                            </label>
                        </div>
                        <div id="amadeusStatus" class="status pending">Not validated</div>
                    </div>
                </div>

                <div class="card">
                    <h2>OpenWeather Configuration</h2>
                    <div class="api-group">
                        <div class="api-header">
                            <span class="api-title">OpenWeather API</span>
                            <button class="validate-btn" onclick="validateApi('openweather')">Validate</button>
                        </div>
                        <div class="form-group">
                            <label for="weatherKey">API Key</label>
                            <input type="password" id="weatherKey" placeholder="API Key">
                        </div>
                        <div class="form-group">
                            <label for="weatherUnits">Units</label>
                            <select id="weatherUnits">
                                <option value="metric">Metric (°C)</option>
                                <option value="imperial">Imperial (°F)</option>
                                <option value="kelvin">Kelvin</option>
                            </select>
                        </div>
                        <div id="weatherStatus" class="status pending">Not validated</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Pinecone Vector Database</h2>
                    <div class="api-group">
                        <div class="api-header">
                            <span class="api-title">Pinecone API</span>
                            <button class="validate-btn" onclick="validateApi('pinecone')">Validate</button>
                        </div>
                        <div class="form-group">
                            <label for="pineconeApiKey">API Key</label>
                            <input type="password" id="pineconeApiKey" placeholder="pcsk_...">
                        </div>
                        <div class="form-group">
                            <label for="pineconeEnvironment">Environment</label>
                            <input type="text" id="pineconeEnvironment" placeholder="us-east-1 (optional)">
                        </div>
                        <div class="form-group">
                            <label for="pineconeIndexName">Index Name</label>
                            <input type="text" id="pineconeIndexName" placeholder="voicebot-docs (default: voicebot-docs)">
                        </div>
                        <div id="pineconeStatus" class="status pending">Not validated</div>
                    </div>
                </div>
            </div>
            
            <!-- Custom APIs Section -->
            <div class="card" style="margin-top: 20px;">
                <h2>Custom API Configurations</h2>
                <div id="custom-apis-list" style="margin-bottom: 15px;">
                    <!-- Custom APIs will be rendered here -->
                </div>
                <button class="button primary" onclick="openCustomApiModal()">+ Add Custom API</button>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="button success" onclick="saveApiKeys()">Save All API Configurations</button>
            </div>
        </div>

        <!-- Tools & Workflows Tab -->
        <div id="tools-tab" class="tab-content">
            <div class="main-grid">
                <!-- Tools Configuration -->
                <div class="card">
                    <h2>Tool Definitions</h2>
                    <p>Configure tools available to the voice assistant</p>
                    
                    <div id="tools-list" style="margin-top: 20px;">
                        <!-- Tool cards will be dynamically loaded here -->
                    </div>
                    
                    <button class="button" onclick="addNewTool()" style="margin-top: 20px;">
                        ➕ Add Custom Tool
                    </button>
                </div>

                <!-- Workflows -->
                <div class="card">
                    <h2>Workflows</h2>
                    <p>Create multi-step workflows for complex tasks</p>
                    
                    <div id="workflows-list" style="margin-top: 20px;">
                        <!-- Workflow cards will be dynamically loaded here -->
                    </div>
                    
                    <button class="button" onclick="createNewWorkflow()" style="margin-top: 20px;">
                        ➕ Create Workflow
                    </button>
                </div>
            </div>

            <!-- Tool Editor Modal -->
            <div id="tool-editor-modal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 800px;">
                    <span class="close" onclick="closeToolEditor()">&times;</span>
                    <h2>Tool Configuration</h2>
                    
                    <form id="tool-form">
                        <div class="form-group">
                            <label>Tool Name</label>
                            <input type="text" id="tool-name" placeholder="e.g., search_documents" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="tool-description" rows="3" placeholder="What this tool does"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Tool Type</label>
                            <select id="tool-type" onchange="updateToolTypeFields()">
                                <option value="api">API Call</option>
                                <option value="rag">RAG Search</option>
                                <option value="function">Custom Function</option>
                                <option value="agent">Agent Handoff</option>
                            </select>
                        </div>
                        
                        <div id="tool-config-fields">
                            <!-- Dynamic fields based on tool type -->
                        </div>
                        
                        <div class="form-group">
                            <label>Parameters (JSON Schema)</label>
                            <textarea id="tool-parameters" rows="10" placeholder='{"type": "object", "properties": {...}}'></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="tool-enabled" checked> Enabled
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="button secondary" onclick="closeToolEditor()">Cancel</button>
                            <button type="submit" class="button">Save Tool</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Workflow Builder Modal -->
            <div id="workflow-builder-modal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 900px;">
                    <span class="close" onclick="closeWorkflowBuilder()">&times;</span>
                    <h2>Workflow Builder</h2>
                    
                    <form id="workflow-form">
                        <div class="form-group">
                            <label>Workflow Name</label>
                            <input type="text" id="workflow-name" placeholder="e.g., Book Flight with Weather Check" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="workflow-description" rows="3" placeholder="What this workflow accomplishes"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Trigger Phrases</label>
                            <input type="text" id="workflow-triggers" placeholder="e.g., book a flight, plan my trip (comma-separated)">
                        </div>
                        
                        <h3>Workflow Steps</h3>
                        <div id="workflow-steps" style="margin-top: 20px;">
                            <!-- Steps will be added dynamically -->
                        </div>
                        
                        <button type="button" class="button secondary" onclick="addWorkflowStep()" style="margin-top: 10px;">
                            ➕ Add Step
                        </button>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button type="button" class="button secondary" onclick="closeWorkflowBuilder()">Cancel</button>
                            <button type="submit" class="button">Save Workflow</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Test Assistant Tab -->
        <div id="test-tab" class="tab-content">
            <div class="card">
                <h2>Test Voice Assistant</h2>
                <p>Test your voice assistant with the current configuration</p>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button class="button" onclick="window.open('/voice-agent.html', '_blank')">
                        🎙️ Open Voice Assistant
                    </button>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>Test Queries</h3>
                    <ul style="color: #666; line-height: 1.8;">
                        <li>"Search for information about [topic] in my documents"</li>
                        <li>"What's the weather in New York?"</li>
                        <li>"Find flights from JFK to LAX next Monday"</li>
                        <li>"Search the web for latest AI news"</li>
                        <li>"List all uploaded documents"</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom API Modal -->
    <div id="custom-api-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCustomApiModal()">&times;</span>
            <h2>Configure Custom API</h2>
            <form id="custom-api-form" onsubmit="saveCustomApi(event)">
                <div class="form-group">
                    <label for="custom-api-name">API Name</label>
                    <input type="text" id="custom-api-name" placeholder="e.g., stripe, twilio" required>
                </div>
                
                <div class="form-group">
                    <label for="custom-api-category">Category</label>
                    <select id="custom-api-category">
                        <option value="payment">Payment</option>
                        <option value="communication">Communication</option>
                        <option value="database">Database</option>
                        <option value="analytics">Analytics</option>
                        <option value="social">Social Media</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="custom-api-endpoint">API Endpoint</label>
                    <input type="text" id="custom-api-endpoint" placeholder="https://api.example.com/v1/" required>
                </div>
                
                <div class="form-group">
                    <label>API Credentials</label>
                    <div id="api-credentials">
                        <div class="credential-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" placeholder="Key name (e.g., apiKey)" class="cred-key" style="flex: 1;">
                            <input type="password" placeholder="Value" class="cred-value" style="flex: 2;">
                            <button type="button" onclick="removeCredential(this)" class="button danger small">Remove</button>
                        </div>
                    </div>
                    <button type="button" onclick="addCredential()" class="button secondary small">+ Add Credential</button>
                </div>
                
                <div class="form-group">
                    <label for="custom-tool-instruction">Tool Instructions</label>
                    <textarea id="custom-tool-instruction" rows="5" placeholder="Instructions for the AI on how to use this API...">Use this API for [purpose]. Always [specific behavior].
When users ask about [topic], use this tool to [action].
Format responses with [formatting guidelines].</textarea>
                </div>
                
                <div class="form-group">
                    <label for="custom-tool-params">Tool Parameters Schema (JSON)</label>
                    <textarea id="custom-tool-params" rows="8">{
  "type": "object",
  "properties": {
    "query": { "type": "string", "description": "Query parameter" }
  },
  "required": ["query"]
}</textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="custom-api-enabled" checked> Enable this API
                    </label>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" onclick="closeCustomApiModal()" class="button secondary">Cancel</button>
                    <button type="submit" class="button primary">Save API</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Tab switching
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll('.tab').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            // Mark tab button as active
            event.target.classList.add('active');
            
            // Load data for the tab if needed
            if (tab === 'documents') {
                loadDocuments();
            } else if (tab === 'tools') {
                loadToolsAndWorkflows();
            }
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.className = `alert show ${type}`;
            alert.textContent = message;
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        // Load settings on page load
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                if (response.ok) {
                    const settings = await response.json();
                    
                    // Populate form fields
                    document.getElementById('voice').value = settings.voice || 'shimmer';
                    document.getElementById('model').value = settings.model || 'gpt-realtime';
                    document.getElementById('temperature').value = settings.temperature || 0.8;
                    document.getElementById('instructions').value = settings.instructions || '';
                    document.getElementById('greeting').value = settings.greeting || '';
                    document.getElementById('useEmoji').checked = settings.useEmoji || false;
                    document.getElementById('useHumor').checked = settings.useHumor || true;
                    document.getElementById('beExpressive').checked = settings.beExpressive || true;
                    document.getElementById('maxTokens').value = settings.maxTokens || 4096;
                    document.getElementById('sessionTimeout').value = settings.sessionTimeout || 300;
                    document.getElementById('contextWindow').value = settings.contextWindow || 'medium';
                    
                    // Feature toggles
                    document.getElementById('ragEnabled').checked = settings.tools?.ragEnabled !== false;
                    document.getElementById('webSearchEnabled').checked = settings.tools?.webSearchEnabled !== false;
                    document.getElementById('flightSearchEnabled').checked = settings.tools?.flightSearchEnabled !== false;
                    document.getElementById('weatherEnabled').checked = settings.tools?.weatherEnabled !== false;
                    document.getElementById('cameraEnabled').checked = settings.tools?.cameraEnabled !== false;
                    
                    // Load camera settings
                    if (settings.cameraSettings) {
                        const res = settings.cameraSettings.width + 'x' + settings.cameraSettings.height;
                        if (document.getElementById('cameraResolution').querySelector(`option[value="${res}"]`)) {
                            document.getElementById('cameraResolution').value = res;
                        }
                        document.getElementById('cameraQuality').value = settings.cameraSettings.quality || 0.92;
                        document.getElementById('cameraQualityValue').textContent = Math.round((settings.cameraSettings.quality || 0.92) * 100) + '%';
                        document.getElementById('cameraFrameRate').value = settings.cameraSettings.frameRate || 30;
                    }
                    
                    document.getElementById('moderationEnabled').checked = settings.moderationEnabled !== false;
                    document.getElementById('loggingEnabled').checked = settings.loggingEnabled !== false;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
            
            // Load API keys (masked)
            try {
                const response = await fetch('/api/apikeys');
                if (response.ok) {
                    const apis = await response.json();
                    
                    if (apis.openai) {
                        document.getElementById('openaiKey').value = apis.openai.apiKey || '';
                        document.getElementById('openaiOrg').value = apis.openai.organization || '';
                    }
                    
                    if (apis.google) {
                        document.getElementById('googleKey').value = apis.google.apiKey || '';
                        document.getElementById('googleSearchEngineId').value = apis.google.searchEngineId || '';
                    }
                    
                    if (apis.amadeus) {
                        document.getElementById('amadeusClientId').value = apis.amadeus.clientId || '';
                        document.getElementById('amadeusClientSecret').value = apis.amadeus.clientSecret || '';
                        document.getElementById('amadeusSandbox').checked = apis.amadeus.sandbox !== false;
                    }
                    
                    if (apis.openweather) {
                        document.getElementById('weatherKey').value = apis.openweather.apiKey || '';
                        document.getElementById('weatherUnits').value = apis.openweather.units || 'metric';
                    }
                    
                    if (apis.pinecone) {
                        document.getElementById('pineconeApiKey').value = apis.pinecone.apiKey || '';
                        document.getElementById('pineconeEnvironment').value = apis.pinecone.environment || '';
                        document.getElementById('pineconeIndexName').value = apis.pinecone.indexName || '';
                    }
                }
            } catch (error) {
                console.error('Error loading API keys:', error);
            }
        }

        // Save settings
        async function saveSettings() {
            console.log('saveSettings called!');
            const settings = {
                voice: document.getElementById('voice').value,
                model: document.getElementById('model').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                instructions: document.getElementById('instructions').value,
                greeting: document.getElementById('greeting').value,
                useEmoji: document.getElementById('useEmoji').checked,
                useHumor: document.getElementById('useHumor').checked,
                beExpressive: document.getElementById('beExpressive').checked,
                maxTokens: parseInt(document.getElementById('maxTokens').value),
                sessionTimeout: parseInt(document.getElementById('sessionTimeout').value),
                contextWindow: document.getElementById('contextWindow').value,
                tools: {
                    ragEnabled: document.getElementById('ragEnabled').checked,
                    webSearchEnabled: document.getElementById('webSearchEnabled').checked,
                    flightSearchEnabled: document.getElementById('flightSearchEnabled').checked,
                    weatherEnabled: document.getElementById('weatherEnabled').checked,
                    cameraEnabled: document.getElementById('cameraEnabled').checked
                },
                cameraSettings: {
                    width: parseInt(document.getElementById('cameraResolution').value.split('x')[0]),
                    height: parseInt(document.getElementById('cameraResolution').value.split('x')[1]),
                    quality: parseFloat(document.getElementById('cameraQuality').value),
                    frameRate: parseInt(document.getElementById('cameraFrameRate').value)
                },
                moderationEnabled: document.getElementById('moderationEnabled').checked,
                loggingEnabled: document.getElementById('loggingEnabled').checked
            };
            
            console.log('Settings to save:', settings);
            
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                console.log('Save response status:', response.status);
                
                if (response.ok) {
                    showAlert('Settings saved successfully!', 'success');
                    console.log('Settings saved successfully!');
                } else {
                    showAlert('Error saving settings', 'error');
                    console.error('Error saving settings - status:', response.status);
                }
            } catch (error) {
                showAlert('Error saving settings', 'error');
                console.error('Save error:', error);
            }
        }

        // Save API keys
        async function saveApiKeys() {
            const apis = {
                openai: {
                    apiKey: document.getElementById('openaiKey').value,
                    organization: document.getElementById('openaiOrg').value,
                    enabled: true,
                    category: 'ai'
                },
                google: {
                    apiKey: document.getElementById('googleKey').value,
                    searchEngineId: document.getElementById('googleSearchEngineId').value,
                    enabled: true,
                    category: 'search'
                },
                amadeus: {
                    clientId: document.getElementById('amadeusClientId').value,
                    clientSecret: document.getElementById('amadeusClientSecret').value,
                    sandbox: document.getElementById('amadeusSandbox').checked,
                    enabled: true,
                    category: 'travel'
                },
                openweather: {
                    apiKey: document.getElementById('weatherKey').value,
                    units: document.getElementById('weatherUnits').value,
                    enabled: true,
                    category: 'weather'
                },
                pinecone: {
                    apiKey: document.getElementById('pineconeApiKey').value,
                    environment: document.getElementById('pineconeEnvironment').value,
                    indexName: document.getElementById('pineconeIndexName').value,
                    enabled: true,
                    category: 'database'
                }
            };
            
            try {
                const response = await fetch('/api/apikeys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(apis)
                });
                
                if (response.ok) {
                    showAlert('API keys saved successfully!', 'success');
                } else {
                    showAlert('Error saving API keys', 'error');
                }
            } catch (error) {
                showAlert('Error saving API keys', 'error');
                console.error('Save error:', error);
            }
        }

        // Validate API
        async function validateApi(apiName) {
            const statusEl = document.getElementById(`${apiName}Status`);
            statusEl.className = 'status pending';
            statusEl.textContent = 'Validating...';
            
            try {
                const response = await fetch(`/api/apikeys/validate/${apiName}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.valid) {
                    statusEl.className = 'status valid';
                    statusEl.textContent = 'Valid';
                } else {
                    statusEl.className = 'status invalid';
                    statusEl.textContent = result.error || 'Invalid';
                }
            } catch (error) {
                statusEl.className = 'status invalid';
                statusEl.textContent = 'Validation failed';
            }
        }

        // Document Management Functions
        
        // Setup file upload
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        
        // Setup drag and drop
        const uploadZone = document.getElementById('uploadZone');
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        async function handleFileUpload(event) {
            handleFiles(event.target.files);
        }

        async function handleFiles(files) {
            const uploadLoading = document.getElementById('uploadLoading');
            uploadLoading.classList.add('active');
            
            for (const file of files) {
                const formData = new FormData();
                formData.append('document', file);
                
                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showAlert(`Document "${file.name}" uploaded successfully!`, 'success');
                    } else {
                        showAlert(`Error uploading "${file.name}": ${result.error}`, 'error');
                    }
                } catch (error) {
                    showAlert(`Error uploading "${file.name}"`, 'error');
                }
            }
            
            uploadLoading.classList.remove('active');
            loadDocuments();
            document.getElementById('fileInput').value = '';
        }

        async function loadDocuments() {
            try {
                const response = await fetch('/api/documents');
                const result = await response.json();
                
                if (result.success) {
                    const documentList = document.getElementById('documentList');
                    const documentCount = document.getElementById('documentCount');
                    
                    documentCount.textContent = `${result.count} documents`;
                    
                    if (result.documents.length === 0) {
                        documentList.innerHTML = '<p style="text-align: center; color: #666;">No documents uploaded yet</p>';
                    } else {
                        documentList.innerHTML = result.documents.map(doc => `
                            <div class="document-item">
                                <div class="document-info">
                                    <div class="document-name">${doc.fileName}</div>
                                    <div class="document-meta">
                                        ${doc.fileType} • ${formatFileSize(doc.size)} • ${doc.chunks} chunks
                                        <br>Uploaded: ${new Date(doc.uploadedAt).toLocaleDateString()}
                                        ${doc.accessCount > 0 ? `• Accessed ${doc.accessCount} times` : ''}
                                    </div>
                                </div>
                                <div class="document-actions">
                                    <button class="button secondary" onclick="viewDocument('${doc.id}')">View</button>
                                    <button class="button danger" onclick="deleteDocument('${doc.id}', '${doc.fileName}')">Delete</button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                showAlert('Error loading documents', 'error');
            }
        }

        async function searchDocuments() {
            const query = document.getElementById('searchQuery').value;
            if (!query) {
                showAlert('Please enter a search query', 'info');
                return;
            }
            
            const searchResults = document.getElementById('searchResults');
            const searchResultsList = document.getElementById('searchResultsList');
            
            searchResults.classList.add('active');
            searchResultsList.innerHTML = '<p>Searching...</p>';
            
            try {
                const response = await fetch('/api/documents/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, limit: 5 })
                });
                
                const result = await response.json();
                
                if (result.success && result.results.length > 0) {
                    searchResultsList.innerHTML = result.results.map(item => `
                        <div class="result-item">
                            <strong>${item.fileName}</strong>
                            <span class="result-score">${(item.relevanceScore * 100).toFixed(0)}%</span>
                            <p style="margin-top: 8px; font-size: 14px; color: #666;">
                                ${item.content.substring(0, 200)}...
                            </p>
                        </div>
                    `).join('');
                } else {
                    searchResultsList.innerHTML = '<p>No results found</p>';
                }
            } catch (error) {
                searchResultsList.innerHTML = '<p>Search error occurred</p>';
                showAlert('Error searching documents', 'error');
            }
        }

        async function viewDocument(documentId) {
            try {
                const response = await fetch(`/api/documents/${documentId}`);
                const result = await response.json();
                
                if (result.success) {
                    // Open in new window or modal
                    const content = result.document.content;
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(`
                        <html>
                        <head>
                            <title>${result.document.fileName}</title>
                            <style>
                                body { font-family: -apple-system, sans-serif; padding: 20px; }
                                pre { white-space: pre-wrap; }
                            </style>
                        </head>
                        <body>
                            <h1>${result.document.fileName}</h1>
                            <pre>${content}</pre>
                        </body>
                        </html>
                    `);
                }
            } catch (error) {
                showAlert('Error viewing document', 'error');
            }
        }

        async function deleteDocument(documentId, fileName) {
            if (!confirm(`Delete "${fileName}"?`)) return;
            
            try {
                const response = await fetch(`/api/documents/${documentId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Document "${fileName}" deleted`, 'success');
                    loadDocuments();
                } else {
                    showAlert('Error deleting document', 'error');
                }
            } catch (error) {
                showAlert('Error deleting document', 'error');
            }
        }

        async function clearAllDocuments() {
            if (!confirm('Delete all documents? This cannot be undone.')) return;
            
            try {
                const response = await fetch('/api/documents', {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('All documents cleared', 'success');
                    loadDocuments();
                } else {
                    showAlert('Error clearing documents', 'error');
                }
            } catch (error) {
                showAlert('Error clearing documents', 'error');
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Custom API Management Functions
        let customApis = {};
        
        async function loadCustomApis() {
            try {
                const response = await fetch('/api/apikeys');
                const apis = await response.json();
                
                // Filter out standard APIs to get custom ones
                const standardApis = ['openai', 'google', 'amadeus', 'openweather', 'pinecone'];
                customApis = {};
                
                for (const [key, value] of Object.entries(apis)) {
                    if (!standardApis.includes(key)) {
                        customApis[key] = value;
                    }
                }
                
                renderCustomApis();
            } catch (error) {
                console.error('Failed to load custom APIs:', error);
            }
        }
        
        function renderCustomApis() {
            const container = document.getElementById('custom-apis-list');
            
            if (Object.keys(customApis).length === 0) {
                container.innerHTML = '<p style="color: #666;">No custom APIs configured yet</p>';
                return;
            }
            
            container.innerHTML = Object.entries(customApis).map(([name, config]) => `
                <div class="api-group">
                    <div class="api-header">
                        <span class="api-title">${name.charAt(0).toUpperCase() + name.slice(1)} API</span>
                        <div>
                            <button class="validate-btn" onclick="validateCustomApi('${name}')">Validate</button>
                            <button class="button danger small" onclick="deleteCustomApi('${name}')">Delete</button>
                        </div>
                    </div>
                    <div style="color: #999; font-size: 14px; margin: 10px 0;">
                        Category: ${config.category || 'other'}<br>
                        ${config.endpoint ? `Endpoint: ${config.endpoint}` : ''}
                        ${config.enabled ? '<span style="color: #28a745;">✓ Enabled</span>' : '<span style="color: #dc3545;">✗ Disabled</span>'}
                    </div>
                    ${config.instruction ? `<div style="background: #1e1f21; padding: 10px; border-radius: 4px; margin-top: 10px;">
                        <strong>Tool Instructions:</strong><br>
                        <pre style="white-space: pre-wrap; color: #888; font-size: 12px;">${config.instruction}</pre>
                    </div>` : ''}
                </div>
            `).join('');
        }
        
        function openCustomApiModal() {
            document.getElementById('custom-api-modal').style.display = 'block';
            document.getElementById('custom-api-form').reset();
        }
        
        function closeCustomApiModal() {
            document.getElementById('custom-api-modal').style.display = 'none';
        }
        
        function addCredential() {
            const container = document.getElementById('api-credentials');
            const row = document.createElement('div');
            row.className = 'credential-row';
            row.style = 'display: flex; gap: 10px; margin-bottom: 10px;';
            row.innerHTML = `
                <input type="text" placeholder="Key name (e.g., apiKey)" class="cred-key" style="flex: 1;">
                <input type="password" placeholder="Value" class="cred-value" style="flex: 2;">
                <button type="button" onclick="removeCredential(this)" class="button danger small">Remove</button>
            `;
            container.appendChild(row);
        }
        
        function removeCredential(button) {
            button.parentElement.remove();
        }
        
        async function saveCustomApi(event) {
            event.preventDefault();
            
            const name = document.getElementById('custom-api-name').value.toLowerCase().replace(/\s+/g, '_');
            const category = document.getElementById('custom-api-category').value;
            const endpoint = document.getElementById('custom-api-endpoint').value;
            const instruction = document.getElementById('custom-tool-instruction').value;
            const enabled = document.getElementById('custom-api-enabled').checked;
            
            // Collect credentials
            const credentials = {};
            const credRows = document.querySelectorAll('.credential-row');
            credRows.forEach(row => {
                const key = row.querySelector('.cred-key').value;
                const value = row.querySelector('.cred-value').value;
                if (key && value) {
                    credentials[key] = value;
                }
            });
            
            // Parse tool parameters
            let toolParams;
            try {
                toolParams = JSON.parse(document.getElementById('custom-tool-params').value);
            } catch (error) {
                showAlert('Invalid tool parameters JSON', 'error');
                return;
            }
            
            // Create API configuration
            const apiConfig = {
                ...credentials,
                category,
                endpoint,
                enabled,
                instruction,
                toolParams
            };
            
            // Save to custom APIs
            customApis[name] = apiConfig;
            
            // Update tool instructions in settings if needed
            await updateToolInstructions(name, instruction);
            
            // Save all API keys including custom
            await saveAllApiKeys();
            
            closeCustomApiModal();
            renderCustomApis();
            showAlert(`Custom API '${name}' saved successfully`, 'success');
        }
        
        async function updateToolInstructions(apiName, instruction) {
            try {
                // Get current settings
                const settingsResponse = await fetch('/api/settings');
                const settings = await settingsResponse.json();
                
                // Update tool instructions
                if (!settings.toolInstructions) {
                    settings.toolInstructions = {};
                }
                settings.toolInstructions[apiName] = instruction;
                
                // Save updated settings
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
            } catch (error) {
                console.error('Failed to update tool instructions:', error);
            }
        }
        
        async function deleteCustomApi(name) {
            if (confirm(`Delete custom API '${name}'?`)) {
                delete customApis[name];
                await saveAllApiKeys();
                renderCustomApis();
                showAlert(`Custom API '${name}' deleted`, 'success');
            }
        }
        
        async function validateCustomApi(name) {
            // Custom validation logic based on API type
            showAlert(`Validating ${name} API...`, 'info');
            // You can implement specific validation logic here
        }
        
        async function saveAllApiKeys() {
            const apis = {
                openai: {
                    apiKey: document.getElementById('openaiKey').value,
                    organization: document.getElementById('openaiOrg').value,
                    enabled: true,
                    category: 'ai'
                },
                google: {
                    apiKey: document.getElementById('googleKey').value,
                    searchEngineId: document.getElementById('googleSearchEngineId').value,
                    enabled: true,
                    category: 'search'
                },
                amadeus: {
                    clientId: document.getElementById('amadeusClientId').value,
                    clientSecret: document.getElementById('amadeusClientSecret').value,
                    sandbox: document.getElementById('amadeusSandbox').checked,
                    enabled: true,
                    category: 'travel'
                },
                openweather: {
                    apiKey: document.getElementById('weatherKey').value,
                    units: document.getElementById('weatherUnits').value,
                    enabled: true,
                    category: 'weather'
                },
                pinecone: {
                    apiKey: document.getElementById('pineconeApiKey').value,
                    environment: document.getElementById('pineconeEnvironment').value,
                    indexName: document.getElementById('pineconeIndexName').value,
                    enabled: true,
                    category: 'database'
                },
                ...customApis  // Include all custom APIs
            };
            
            try {
                const response = await fetch('/api/apikeys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(apis)
                });
                
                if (response.ok) {
                    showAlert('All API configurations saved', 'success');
                } else {
                    showAlert('Error saving API configurations', 'error');
                }
            } catch (error) {
                showAlert('Error saving API configurations', 'error');
            }
        }
        
        // Update the original saveApiKeys to use saveAllApiKeys
        async function saveApiKeys() {
            await saveAllApiKeys();
        }
        
        // Camera settings event handlers
        function setupCameraSettings() {
            const cameraCheckbox = document.getElementById('cameraEnabled');
            const cameraSettingsGroup = document.getElementById('cameraSettingsGroup');
            const qualitySlider = document.getElementById('cameraQuality');
            const qualityValue = document.getElementById('cameraQualityValue');
            
            // Toggle camera settings visibility
            if (cameraCheckbox) {
                cameraCheckbox.addEventListener('change', (e) => {
                    cameraSettingsGroup.style.display = e.target.checked ? 'block' : 'none';
                });
                
                // Set initial state
                cameraSettingsGroup.style.display = cameraCheckbox.checked ? 'block' : 'none';
            }
            
            // Update quality display value
            if (qualitySlider) {
                qualitySlider.addEventListener('input', (e) => {
                    qualityValue.textContent = Math.round(e.target.value * 100) + '%';
                });
            }
        }
        
        // Load settings on page load
        window.addEventListener('load', () => {
            loadSettings();
            loadDocuments();
            loadCustomApis();
            setupCameraSettings();
        });
    </script>
</body>
</html>