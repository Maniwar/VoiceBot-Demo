<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceBot Admin - Complete Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .button.secondary {
            background: #6c757d;
        }

        .button.danger {
            background: #dc3545;
        }

        .button.success {
            background: #28a745;
        }

        .api-group {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .api-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .api-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .validate-btn {
            padding: 6px 12px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status.valid {
            background: #d4edda;
            color: #155724;
        }

        .status.invalid {
            background: #f8d7da;
            color: #721c24;
        }

        .status.pending {
            background: #fff3cd;
            color: #856404;
        }

        /* Document Management Styles */
        .document-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }

        .document-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .document-info {
            flex: 1;
        }

        .document-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .document-meta {
            font-size: 12px;
            color: #666;
        }

        .document-actions {
            display: flex;
            gap: 8px;
        }

        .upload-zone {
            border: 3px dashed #e0e0e0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .search-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .search-results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .result-item {
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .result-score {
            display: inline-block;
            padding: 2px 6px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è VoiceBot Admin Panel</h1>
            <p>Configure your AI voice assistant, manage documents, and API integrations</p>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('bot')">Bot Settings</button>
                <button class="tab" onclick="switchTab('documents')">Document Management</button>
                <button class="tab" onclick="switchTab('apis')">API Configuration</button>
                <button class="tab" onclick="switchTab('tools')">Tools & Workflows</button>
                <button class="tab" onclick="switchTab('test')">Test Assistant</button>
            </div>
        </div>

        <div id="alert" class="alert"></div>

        <!-- Bot Settings Tab -->
        <div id="bot-tab" class="tab-content active">
            <div class="main-grid">
                <div class="card">
                    <h2>Voice Configuration</h2>
                    <div class="form-group">
                        <label for="voice">Voice Selection</label>
                        <select id="voice">
                            <option value="alloy">Alloy (Neutral)</option>
                            <option value="shimmer" selected>Shimmer (Expressive)</option>
                            <option value="echo">Echo (Smooth)</option>
                            <option value="ash">Ash</option>
                            <option value="ballad">Ballad</option>
                            <option value="coral">Coral</option>
                            <option value="sage">Sage</option>
                            <option value="verse">Verse</option>
                            <option value="marin">Marin</option>
                            <option value="cedar">Cedar</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="model">Model</label>
                        <select id="model">
                            <option value="gpt-4o-realtime-preview" selected>GPT-4o Realtime Preview</option>
                            <option value="gpt-realtime">GPT Realtime</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="temperature">Temperature (0-2)</label>
                        <input type="number" id="temperature" min="0" max="2" step="0.1" value="0.8">
                    </div>
                    
                    <button class="button" onclick="saveSettings()">Save Voice Settings</button>
                </div>

                <div class="card">
                    <h2>Personality & Behavior</h2>
                    <div class="form-group">
                        <label for="instructions">System Instructions</label>
                        <textarea id="instructions">You are an incredibly expressive and enthusiastic voice assistant with a vibrant personality! Speak with natural emotion, varying your tone, pace, and inflection to match the context.</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="greeting">Greeting Message</label>
                        <input type="text" id="greeting" value="Hello! I'm your AI assistant. How can I help you today?">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="useEmoji"> Use Emojis
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="useHumor" checked> Use Humor
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="beExpressive" checked> Be Expressive
                        </label>
                    </div>
                    
                    <button class="button" onclick="saveSettings()">Save Personality</button>
                </div>

                <div class="card">
                    <h2>Session Settings</h2>
                    <div class="form-group">
                        <label for="maxTokens">Max Tokens</label>
                        <input type="number" id="maxTokens" value="4096">
                    </div>
                    
                    <div class="form-group">
                        <label for="sessionTimeout">Session Timeout (seconds)</label>
                        <input type="number" id="sessionTimeout" value="300">
                    </div>
                    
                    <div class="form-group">
                        <label for="contextWindow">Context Window</label>
                        <select id="contextWindow">
                            <option value="short">Short (2k tokens)</option>
                            <option value="medium" selected>Medium (4k tokens)</option>
                            <option value="long">Long (8k tokens)</option>
                        </select>
                    </div>
                    
                    <button class="button" onclick="saveSettings()">Save Session Settings</button>
                </div>

                <div class="card">
                    <h2>Feature Toggles</h2>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="ragEnabled" checked> Enable RAG (Document Search)
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="webSearchEnabled" checked> Enable Web Search
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="flightSearchEnabled" checked> Enable Flight Search
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="weatherEnabled" checked> Enable Weather
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="moderationEnabled" checked> Enable Content Moderation
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="loggingEnabled" checked> Enable Conversation Logging
                        </label>
                    </div>
                    
                    <button class="button" onclick="saveSettings()">Save Features</button>
                </div>
            </div>
        </div>

        <!-- Document Management Tab -->
        <div id="documents-tab" class="tab-content">
            <div class="main-grid">
                <div class="card">
                    <h2>Upload Documents</h2>
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                        <p>üìÅ Click or drag files here to upload</p>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            Supported: PDF, TXT, MD, CSV, JSON, PNG, JPG
                        </p>
                        <input type="file" id="fileInput" style="display: none;" multiple accept=".pdf,.txt,.md,.csv,.json,.png,.jpg,.jpeg">
                    </div>
                    
                    <div class="loading" id="uploadLoading">
                        <div class="spinner"></div>
                        <p>Processing documents...</p>
                    </div>
                </div>

                <div class="card">
                    <h2>Search Documents</h2>
                    <div class="search-box">
                        <input type="text" class="search-input" id="searchQuery" placeholder="Enter search query...">
                        <button class="search-button" onclick="searchDocuments()">Search</button>
                    </div>
                    
                    <div class="search-results" id="searchResults">
                        <h3>Search Results</h3>
                        <div id="searchResultsList"></div>
                    </div>
                </div>

                <div class="card" style="grid-column: 1 / -1;">
                    <h2>Document Library</h2>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span id="documentCount">0 documents</span>
                        <button class="button danger" onclick="clearAllDocuments()">Clear All</button>
                    </div>
                    
                    <div class="document-list" id="documentList">
                        <p style="text-align: center; color: #666;">No documents uploaded yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Configuration Tab -->
        <div id="apis-tab" class="tab-content">
            <div class="main-grid">
                <div class="card">
                    <h2>OpenAI Configuration</h2>
                    <div class="api-group">
                        <div class="api-header">
                            <span class="api-title">OpenAI API</span>
                            <button class="validate-btn" onclick="validateApi('openai')">Validate</button>
                        </div>
                        <div class="form-group">
                            <label for="openaiKey">API Key</label>
                            <input type="password" id="openaiKey" placeholder="sk-...">
                        </div>
                        <div class="form-group">
                            <label for="openaiOrg">Organization ID (Optional)</label>
                            <input type="text" id="openaiOrg" placeholder="org-...">
                        </div>
                        <div id="openaiStatus" class="status pending">Not validated</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Google Search Configuration</h2>
                    <div class="api-group">
                        <div class="api-header">
                            <span class="api-title">Google Custom Search</span>
                            <button class="validate-btn" onclick="validateApi('google')">Validate</button>
                        </div>
                        <div class="form-group">
                            <label for="googleKey">API Key</label>
                            <input type="password" id="googleKey" placeholder="AIza...">
                        </div>
                        <div class="form-group">
                            <label for="googleSearchEngineId">Search Engine ID</label>
                            <input type="text" id="googleSearchEngineId" placeholder="cx:...">
                        </div>
                        <div id="googleStatus" class="status pending">Not validated</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Amadeus Flight Search</h2>
                    <div class="api-group">
                        <div class="api-header">
                            <span class="api-title">Amadeus API</span>
                            <button class="validate-btn" onclick="validateApi('amadeus')">Validate</button>
                        </div>
                        <div class="form-group">
                            <label for="amadeusClientId">Client ID</label>
                            <input type="text" id="amadeusClientId" placeholder="Client ID">
                        </div>
                        <div class="form-group">
                            <label for="amadeusClientSecret">Client Secret</label>
                            <input type="password" id="amadeusClientSecret" placeholder="Client Secret">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="amadeusSandbox" checked> Use Sandbox Environment
                            </label>
                        </div>
                        <div id="amadeusStatus" class="status pending">Not validated</div>
                    </div>
                </div>

                <div class="card">
                    <h2>OpenWeather Configuration</h2>
                    <div class="api-group">
                        <div class="api-header">
                            <span class="api-title">OpenWeather API</span>
                            <button class="validate-btn" onclick="validateApi('openweather')">Validate</button>
                        </div>
                        <div class="form-group">
                            <label for="weatherKey">API Key</label>
                            <input type="password" id="weatherKey" placeholder="API Key">
                        </div>
                        <div class="form-group">
                            <label for="weatherUnits">Units</label>
                            <select id="weatherUnits">
                                <option value="metric">Metric (¬∞C)</option>
                                <option value="imperial">Imperial (¬∞F)</option>
                                <option value="kelvin">Kelvin</option>
                            </select>
                        </div>
                        <div id="weatherStatus" class="status pending">Not validated</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="button success" onclick="saveApiKeys()">Save All API Configurations</button>
            </div>
        </div>

        <!-- Tools & Workflows Tab -->
        <div id="tools-tab" class="tab-content">
            <div class="card">
                <h2>Available Tools</h2>
                <p>Configure which tools are available to the voice assistant</p>
                
                <div style="margin-top: 20px;">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" checked> Document Search (RAG)
                        </label>
                        <p style="font-size: 12px; color: #666; margin-left: 24px;">Search through uploaded documents</p>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" checked> Web Search
                        </label>
                        <p style="font-size: 12px; color: #666; margin-left: 24px;">Search the web using Google</p>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" checked> Flight Search
                        </label>
                        <p style="font-size: 12px; color: #666; margin-left: 24px;">Search for flights using Amadeus</p>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" checked> Weather Information
                        </label>
                        <p style="font-size: 12px; color: #666; margin-left: 24px;">Get weather information</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Assistant Tab -->
        <div id="test-tab" class="tab-content">
            <div class="card">
                <h2>Test Voice Assistant</h2>
                <p>Test your voice assistant with the current configuration</p>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button class="button" onclick="window.open('/voice-agent.html', '_blank')">
                        üéôÔ∏è Open Voice Assistant
                    </button>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>Test Queries</h3>
                    <ul style="color: #666; line-height: 1.8;">
                        <li>"Search for information about [topic] in my documents"</li>
                        <li>"What's the weather in New York?"</li>
                        <li>"Find flights from JFK to LAX next Monday"</li>
                        <li>"Search the web for latest AI news"</li>
                        <li>"List all uploaded documents"</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll('.tab').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            // Mark tab button as active
            event.target.classList.add('active');
            
            // Load data for the tab if needed
            if (tab === 'documents') {
                loadDocuments();
            }
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.className = `alert show ${type}`;
            alert.textContent = message;
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        // Load settings on page load
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                if (response.ok) {
                    const settings = await response.json();
                    
                    // Populate form fields
                    document.getElementById('voice').value = settings.voice || 'shimmer';
                    document.getElementById('model').value = settings.model || 'gpt-4o-realtime-preview';
                    document.getElementById('temperature').value = settings.temperature || 0.8;
                    document.getElementById('instructions').value = settings.instructions || '';
                    document.getElementById('greeting').value = settings.greeting || '';
                    document.getElementById('useEmoji').checked = settings.useEmoji || false;
                    document.getElementById('useHumor').checked = settings.useHumor || true;
                    document.getElementById('beExpressive').checked = settings.beExpressive || true;
                    document.getElementById('maxTokens').value = settings.maxTokens || 4096;
                    document.getElementById('sessionTimeout').value = settings.sessionTimeout || 300;
                    document.getElementById('contextWindow').value = settings.contextWindow || 'medium';
                    
                    // Feature toggles
                    document.getElementById('ragEnabled').checked = settings.tools?.ragEnabled !== false;
                    document.getElementById('webSearchEnabled').checked = settings.tools?.webSearchEnabled !== false;
                    document.getElementById('flightSearchEnabled').checked = settings.tools?.flightSearchEnabled !== false;
                    document.getElementById('weatherEnabled').checked = settings.tools?.weatherEnabled !== false;
                    document.getElementById('moderationEnabled').checked = settings.moderationEnabled !== false;
                    document.getElementById('loggingEnabled').checked = settings.loggingEnabled !== false;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
            
            // Load API keys (masked)
            try {
                const response = await fetch('/api/apikeys');
                if (response.ok) {
                    const apis = await response.json();
                    
                    if (apis.openai) {
                        document.getElementById('openaiKey').value = apis.openai.apiKey || '';
                        document.getElementById('openaiOrg').value = apis.openai.organization || '';
                    }
                    
                    if (apis.google) {
                        document.getElementById('googleKey').value = apis.google.apiKey || '';
                        document.getElementById('googleSearchEngineId').value = apis.google.searchEngineId || '';
                    }
                    
                    if (apis.amadeus) {
                        document.getElementById('amadeusClientId').value = apis.amadeus.clientId || '';
                        document.getElementById('amadeusClientSecret').value = apis.amadeus.clientSecret || '';
                        document.getElementById('amadeusSandbox').checked = apis.amadeus.sandbox !== false;
                    }
                    
                    if (apis.openweather) {
                        document.getElementById('weatherKey').value = apis.openweather.apiKey || '';
                        document.getElementById('weatherUnits').value = apis.openweather.units || 'metric';
                    }
                }
            } catch (error) {
                console.error('Error loading API keys:', error);
            }
        }

        // Save settings
        async function saveSettings() {
            const settings = {
                voice: document.getElementById('voice').value,
                model: document.getElementById('model').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                instructions: document.getElementById('instructions').value,
                greeting: document.getElementById('greeting').value,
                useEmoji: document.getElementById('useEmoji').checked,
                useHumor: document.getElementById('useHumor').checked,
                beExpressive: document.getElementById('beExpressive').checked,
                maxTokens: parseInt(document.getElementById('maxTokens').value),
                sessionTimeout: parseInt(document.getElementById('sessionTimeout').value),
                contextWindow: document.getElementById('contextWindow').value,
                tools: {
                    ragEnabled: document.getElementById('ragEnabled').checked,
                    webSearchEnabled: document.getElementById('webSearchEnabled').checked,
                    flightSearchEnabled: document.getElementById('flightSearchEnabled').checked,
                    weatherEnabled: document.getElementById('weatherEnabled').checked
                },
                moderationEnabled: document.getElementById('moderationEnabled').checked,
                loggingEnabled: document.getElementById('loggingEnabled').checked
            };
            
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    showAlert('Settings saved successfully!', 'success');
                } else {
                    showAlert('Error saving settings', 'error');
                }
            } catch (error) {
                showAlert('Error saving settings', 'error');
                console.error('Save error:', error);
            }
        }

        // Save API keys
        async function saveApiKeys() {
            const apis = {
                openai: {
                    apiKey: document.getElementById('openaiKey').value,
                    organization: document.getElementById('openaiOrg').value,
                    enabled: true,
                    category: 'ai'
                },
                google: {
                    apiKey: document.getElementById('googleKey').value,
                    searchEngineId: document.getElementById('googleSearchEngineId').value,
                    enabled: true,
                    category: 'search'
                },
                amadeus: {
                    clientId: document.getElementById('amadeusClientId').value,
                    clientSecret: document.getElementById('amadeusClientSecret').value,
                    sandbox: document.getElementById('amadeusSandbox').checked,
                    enabled: true,
                    category: 'travel'
                },
                openweather: {
                    apiKey: document.getElementById('weatherKey').value,
                    units: document.getElementById('weatherUnits').value,
                    enabled: true,
                    category: 'weather'
                }
            };
            
            try {
                const response = await fetch('/api/apikeys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(apis)
                });
                
                if (response.ok) {
                    showAlert('API keys saved successfully!', 'success');
                } else {
                    showAlert('Error saving API keys', 'error');
                }
            } catch (error) {
                showAlert('Error saving API keys', 'error');
                console.error('Save error:', error);
            }
        }

        // Validate API
        async function validateApi(apiName) {
            const statusEl = document.getElementById(`${apiName}Status`);
            statusEl.className = 'status pending';
            statusEl.textContent = 'Validating...';
            
            try {
                const response = await fetch(`/api/apikeys/validate/${apiName}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.valid) {
                    statusEl.className = 'status valid';
                    statusEl.textContent = 'Valid';
                } else {
                    statusEl.className = 'status invalid';
                    statusEl.textContent = result.error || 'Invalid';
                }
            } catch (error) {
                statusEl.className = 'status invalid';
                statusEl.textContent = 'Validation failed';
            }
        }

        // Document Management Functions
        
        // Setup file upload
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        
        // Setup drag and drop
        const uploadZone = document.getElementById('uploadZone');
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        async function handleFileUpload(event) {
            handleFiles(event.target.files);
        }

        async function handleFiles(files) {
            const uploadLoading = document.getElementById('uploadLoading');
            uploadLoading.classList.add('active');
            
            for (const file of files) {
                const formData = new FormData();
                formData.append('document', file);
                
                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showAlert(`Document "${file.name}" uploaded successfully!`, 'success');
                    } else {
                        showAlert(`Error uploading "${file.name}": ${result.error}`, 'error');
                    }
                } catch (error) {
                    showAlert(`Error uploading "${file.name}"`, 'error');
                }
            }
            
            uploadLoading.classList.remove('active');
            loadDocuments();
            document.getElementById('fileInput').value = '';
        }

        async function loadDocuments() {
            try {
                const response = await fetch('/api/documents');
                const result = await response.json();
                
                if (result.success) {
                    const documentList = document.getElementById('documentList');
                    const documentCount = document.getElementById('documentCount');
                    
                    documentCount.textContent = `${result.count} documents`;
                    
                    if (result.documents.length === 0) {
                        documentList.innerHTML = '<p style="text-align: center; color: #666;">No documents uploaded yet</p>';
                    } else {
                        documentList.innerHTML = result.documents.map(doc => `
                            <div class="document-item">
                                <div class="document-info">
                                    <div class="document-name">${doc.fileName}</div>
                                    <div class="document-meta">
                                        ${doc.fileType} ‚Ä¢ ${formatFileSize(doc.size)} ‚Ä¢ ${doc.chunks} chunks
                                        <br>Uploaded: ${new Date(doc.uploadedAt).toLocaleDateString()}
                                        ${doc.accessCount > 0 ? `‚Ä¢ Accessed ${doc.accessCount} times` : ''}
                                    </div>
                                </div>
                                <div class="document-actions">
                                    <button class="button secondary" onclick="viewDocument('${doc.id}')">View</button>
                                    <button class="button danger" onclick="deleteDocument('${doc.id}', '${doc.fileName}')">Delete</button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                showAlert('Error loading documents', 'error');
            }
        }

        async function searchDocuments() {
            const query = document.getElementById('searchQuery').value;
            if (!query) {
                showAlert('Please enter a search query', 'info');
                return;
            }
            
            const searchResults = document.getElementById('searchResults');
            const searchResultsList = document.getElementById('searchResultsList');
            
            searchResults.classList.add('active');
            searchResultsList.innerHTML = '<p>Searching...</p>';
            
            try {
                const response = await fetch('/api/documents/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, limit: 5 })
                });
                
                const result = await response.json();
                
                if (result.success && result.results.length > 0) {
                    searchResultsList.innerHTML = result.results.map(item => `
                        <div class="result-item">
                            <strong>${item.fileName}</strong>
                            <span class="result-score">${(item.relevanceScore * 100).toFixed(0)}%</span>
                            <p style="margin-top: 8px; font-size: 14px; color: #666;">
                                ${item.content.substring(0, 200)}...
                            </p>
                        </div>
                    `).join('');
                } else {
                    searchResultsList.innerHTML = '<p>No results found</p>';
                }
            } catch (error) {
                searchResultsList.innerHTML = '<p>Search error occurred</p>';
                showAlert('Error searching documents', 'error');
            }
        }

        async function viewDocument(documentId) {
            try {
                const response = await fetch(`/api/documents/${documentId}`);
                const result = await response.json();
                
                if (result.success) {
                    // Open in new window or modal
                    const content = result.document.content;
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(`
                        <html>
                        <head>
                            <title>${result.document.fileName}</title>
                            <style>
                                body { font-family: -apple-system, sans-serif; padding: 20px; }
                                pre { white-space: pre-wrap; }
                            </style>
                        </head>
                        <body>
                            <h1>${result.document.fileName}</h1>
                            <pre>${content}</pre>
                        </body>
                        </html>
                    `);
                }
            } catch (error) {
                showAlert('Error viewing document', 'error');
            }
        }

        async function deleteDocument(documentId, fileName) {
            if (!confirm(`Delete "${fileName}"?`)) return;
            
            try {
                const response = await fetch(`/api/documents/${documentId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Document "${fileName}" deleted`, 'success');
                    loadDocuments();
                } else {
                    showAlert('Error deleting document', 'error');
                }
            } catch (error) {
                showAlert('Error deleting document', 'error');
            }
        }

        async function clearAllDocuments() {
            if (!confirm('Delete all documents? This cannot be undone.')) return;
            
            try {
                const response = await fetch('/api/documents', {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('All documents cleared', 'success');
                    loadDocuments();
                } else {
                    showAlert('Error clearing documents', 'error');
                }
            } catch (error) {
                showAlert('Error clearing documents', 'error');
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Load settings on page load
        window.addEventListener('load', () => {
            loadSettings();
            loadDocuments();
        });
    </script>
</body>
</html>